<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>الخريطة التفاعلية – تحليل المؤشرات السكانية واللغوية</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- Awesome Markers -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.5/leaflet.awesome-markers.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.5/leaflet.awesome-markers.js"></script>

<!-- PapaParse (CSV parser) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }

    .legend-box {
        position: fixed;
        bottom: 40px;
        left: 40px;
        background: white;
        border: 2px solid #444;
        border-radius: 6px;
        padding: 10px;
        width: 230px;
        font-size: 14px;
        z-index: 9999;
        line-height: 18px;
    }
    .legend-color {
        width: 12px; 
        height: 12px; 
        display: inline-block; 
        margin-left: 8px;
    }
</style>
</head>

<body>

<div id="map"></div>

<!-- وسيلة الإيضاح -->
<div class="legend-box">
    <b>وسيلة الإيضاح (الكثافة السكانية)</b><br><br>
    <span class="legend-color" style="background: darkred;"></span> كثافة عالية جدًا &gt; 1000 نسمة/كم²<br>
    <span class="legend-color" style="background: orange;"></span> كثافة متوسطة–عالية (500–1000)<br>
    <span class="legend-color" style="background: lightblue;"></span> كثافة متوسطة (100–500)<br>
    <span class="legend-color" style="background: green;"></span> كثافة ضعيفة &lt; 100 نسمة/كم²<br>
</div>

<script>

//--------------------------------------------
// 1) إنشاء الخريطة الأساسية
//--------------------------------------------
var map = L.map('map').setView([28.0, 2.0], 5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: "© OpenStreetMap"
}).addTo(map);

//---------------------------------------------------------
// 2) دالة اختيار اللون حسب الكثافة السكانية
//---------------------------------------------------------
function getColorByDensity(d) {
    if (d > 1000) return "darkred";
    if (d > 500)  return "orange";
    if (d > 100)  return "lightblue";
    return "green";
}

//---------------------------------------------------------
// 3) دالة إنشاء Marker ديناميكي مع Popup عربي
//---------------------------------------------------------
function addMarker(entry) {

    var lat = parseFloat(entry.lat);
    var lon = parseFloat(entry.lon);
    var density = parseFloat(entry.density);

    var icon = L.AwesomeMarkers.icon({
        icon: "info-sign",
        prefix: "glyphicon",
        markerColor: getColorByDensity(density),
        iconColor: "white"
    });

    var marker = L.marker([lat, lon], { icon: icon }).addTo(map);

    var popupContent = `
        <div style="text-align:right;">
            <b>المنطقة:</b> ${entry.region}<br>
            <b>الكثافة السكانية:</b> ${density} نسمة/كم²<br>
            <b>نسبة التشابه الأصلية:</b> ${entry.original_similarity}%<br>
            <b>نسبة التشابه بعد الضبط:</b> ${entry.adjusted_similarity}%<br>
            <b>اللغة/اللهجة السائدة:</b> ${entry.language}
        </div>
    `;
    marker.bindPopup(popupContent);
}

//---------------------------------------------------------
// 4) تحميل البيانات (يمكن استعمال CSV أو JSON)
//    اختر واحدة فقط حسب ملفك
//---------------------------------------------------------

// === صيغة JSON ===
// مثال: data.json
// [
//   {"region":"Algiers","lat":36.75,"lon":3.06,
//    "density":12454.58,"original_similarity":94,
//    "adjusted_similarity":114.73,"language":"العربية"}
// ]
fetch("data.json")
  .then(response => response.json())
  .then(data => {
      data.forEach(row => addMarker(row));
  });


// === صيغة CSV ===
// مثال CSV بنفس الحقول
// region,lat,lon,density,original_similarity,adjusted_similarity,language
/*
Papa.parse("data.csv", {
    download: true,
    header: true,
    complete: function(results) {
        results.data.forEach(row => addMarker(row));
    }
});
*/

//---------------------------------------------------------
// 5) إضافة طبقة حدود الجزائر (GeoJSON)
//---------------------------------------------------------

fetch("algeria_provinces.geojson")
  .then(response => response.json())
  .then(geo => {

      var provinces = L.geoJSON(geo, {
          style: {
              color: "#333",
              weight: 1.5,
              fillColor: "#dddddd",
              fillOpacity: 0.1
          }
      });

      // زر التحكم في الطبقة
      L.control.layers(null, { "حدود الولايات": provinces }).addTo(map);

      provinces.addTo(map);
  });

</script>
</body>
</html>
